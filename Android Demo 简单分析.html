<!DOCTYPE html><html><head>
      <title>Android Demo &#x7B80;&#x5355;&#x5206;&#x6790;</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/liuwenchang/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.5.18/node_modules/@shd101wyy/mume/dependencies/katex/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h2 class="mume-header" id="1-peerconnection-%E5%88%9B%E5%BB%BA">1 PeerConnection &#x521B;&#x5EFA;</h2>

<p>&#x97F3;&#x89C6;&#x9891;&#x4E92;&#x901A;&#x9700;&#x8981;&#x5148;&#x521B;&#x5EFA; PeerConnection&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x521B;&#x5EFA;&#x53CA;&#x4EA4;&#x6362; Sdp&#xFF0C;&#x4EE5;&#x5B8C;&#x6210;&#x901A;&#x8BDD;&#x5EFA;&#x7ACB;&#x3002;</p>
<h3 class="mume-header" id="11-peerconnectionfactory-%E5%88%9B%E5%BB%BA">1.1 PeerConnectionFactory &#x521B;&#x5EFA;</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token class-name">CallActivity</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create peer connection client.</span>
    <span class="token comment">// &#x521B;&#x5EFA; peer connection client, &#x5E76;&#x8C03;&#x7528; PeerConnectionFactory.initialize() &#x52A0;&#x8F7D;&#x52A8;&#x6001;&#x5E93;&#x53CA;&#x4E0A;&#x4E0B;&#x6587;&#x73AF;&#x5883;&#x7B49;.</span>
    peerConnectionClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnectionClient</span><span class="token punctuation">(</span>
        <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eglBase<span class="token punctuation">,</span> peerConnectionParameters<span class="token punctuation">,</span> <span class="token class-name">CallActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnectionFactory */</span>
    <span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PeerConnectionClient</span><span class="token punctuation">.</span><span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    
    <span class="token comment">/* &#x5F00;&#x59CB;&#x901A;&#x8BDD;&#x5EFA;&#x7ACB; */</span>
    <span class="token function">startCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">PeerConnectionFactory<span class="token punctuation">.</span>Options</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;PeerConnectionFactory has already been constructed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">createPeerConnectionFactoryInternal</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">createPeerConnectionFactoryInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
    <span class="token keyword">final</span> <span class="token class-name">AudioDeviceModule</span> adm <span class="token operator">=</span> <span class="token function">createJavaAudioDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x89C6;&#x9891;&#x7F16;&#x7801;&#x662F;&#x5426;&#x4F7F;&#x80FD; H264 high level profile */</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> enableH264HighProfile <span class="token operator">=</span>
        VIDEO_CODEC_H264_HIGH<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCodec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoEncoderFactory</span> encoderFactory<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoDecoderFactory</span> decoderFactory<span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891;&#x7F16;&#x89E3;&#x7801;&#x5DE5;&#x5382;, &#x8F6F;&#x7F16;&#x6216;&#x786C;&#x7F16; */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCodecHwAcceleration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      encoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultVideoEncoderFactory</span><span class="token punctuation">(</span>
          rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* enableIntelVp8Encoder */</span><span class="token punctuation">,</span> enableH264HighProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      decoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultVideoDecoderFactory</span><span class="token punctuation">(</span>rootEglBase<span class="token punctuation">.</span><span class="token function">getEglBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      encoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftwareVideoEncoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      decoderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftwareVideoDecoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* &#x6784;&#x5EFA; PeerConnectionFactory */</span>
    factory <span class="token operator">=</span> <span class="token class-name">PeerConnectionFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setAudioDeviceModule</span><span class="token punctuation">(</span>adm<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setVideoEncoderFactory</span><span class="token punctuation">(</span>encoderFactory<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setVideoDecoderFactory</span><span class="token punctuation">(</span>decoderFactory<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    adm<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/PeerConnectionFactory.java</span>
<span class="token comment">// PeerConnectionFactory.Builder</span>
<span class="token keyword">public</span> <span class="token class-name">PeerConnectionFactory</span> <span class="token function">createPeerConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x901A;&#x8FC7; Jni &#x521B;&#x5EFA; Native &#x5C42; PeerConnectionFactory &#x5BF9;&#x8C61;</span>
    <span class="token keyword">return</span> <span class="token function">nativeCreatePeerConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">ContextUtils</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span>
        <span class="token comment">/* &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x8BBE;&#x5907; Native C++&#x6307;&#x9488; */</span>
        audioDeviceModule<span class="token punctuation">.</span><span class="token function">getNativeAudioDeviceModulePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x7F16;&#x7801;&#x5DE5;&#x5382;&#x7C7B; Native C++ &#x6307;&#x9488; */</span>
        audioEncoderFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeAudioEncoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x89E3;&#x7801;&#x5DE5;&#x5382;&#x7C7B; Native C++ &#x6307;&#x9488; */</span>
        audioDecoderFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeAudioDecoderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* &#x89C6;&#x9891;&#x7F16;&#x7801;&#x5668;&#x5DE5;&#x5382;&#x7C7B;&#x5BF9;&#x8C61; */</span>
        videoEncoderFactory<span class="token punctuation">,</span>
        <span class="token comment">/* &#x89C6;&#x9891;&#x89E3;&#x7801;&#x5668;&#x5DE5;&#x5382;&#x7C7B;&#x5BF9;&#x8C61; */</span>
        videoDecoderFactory<span class="token punctuation">,</span>
        <span class="token comment">/* &#x97F3;&#x9891;&#x589E;&#x5F3A;&#x5904;&#x7406;&#xFF0C;&#x6B64;&#x5904;&#x4E3A; null */</span>
        audioProcessingFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> audioProcessingFactory<span class="token punctuation">.</span><span class="token function">createNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* fec &#x63A7;&#x5236;&#x5668;&#xFF0C;&#x6B64;&#x5904;&#x4E3A; null */</span>
        fecControllerFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> fecControllerFactoryFactory<span class="token punctuation">.</span><span class="token function">createNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        networkControllerFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> networkControllerFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetworkControllerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        networkStatePredictorFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> networkStatePredictorFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetworkStatePredictorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        mediaTransportFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token number">0</span>
            <span class="token operator">:</span> mediaTransportFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeMediaTransportFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* &#x6B64;&#x5904;&#x4E3A; null */</span>
        neteqFactoryFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> neteqFactoryFactory<span class="token punctuation">.</span><span class="token function">createNativeNetEqFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_peerconnection_jni/PeerConnection_factory_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/api/org/webrtc/PeerConnectionFactory.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
<span class="token comment">/* &#x521B;&#x5EFA; Native &#x5C42; PeerConnectionFactory &#x5BF9;&#x8C61; */</span>
JNI_GENERATOR_EXPORT jobject
    <span class="token function">Java_org_webrtc_PeerConnectionFactory_nativeCreatePeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject context<span class="token punctuation">,</span>
    jobject options<span class="token punctuation">,</span>
    jlong nativeAudioDeviceModule<span class="token punctuation">,</span>
    jlong audioEncoderFactory<span class="token punctuation">,</span>
    jlong audioDecoderFactory<span class="token punctuation">,</span>
    jobject encoderFactory<span class="token punctuation">,</span>
    jobject decoderFactory<span class="token punctuation">,</span>
    jlong nativeAudioProcessor<span class="token punctuation">,</span>
    jlong nativeFecControllerFactory<span class="token punctuation">,</span>
    jlong nativeNetworkControllerFactory<span class="token punctuation">,</span>
    jlong nativeNetworkStatePredictorFactory<span class="token punctuation">,</span>
    jlong mediaTransportFactory<span class="token punctuation">,</span>
    jlong neteqFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">JNI_PeerConnectionFactory_CreatePeerConnectionFactory</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        nativeAudioDeviceModule<span class="token punctuation">,</span> 
        audioEncoderFactory<span class="token punctuation">,</span> audioDecoderFactory<span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> encoderFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> decoderFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>
        nativeAudioProcessor<span class="token punctuation">,</span>
        nativeFecControllerFactory<span class="token punctuation">,</span> nativeNetworkControllerFactory<span class="token punctuation">,</span>
        nativeNetworkStatePredictorFactory<span class="token punctuation">,</span> mediaTransportFactory<span class="token punctuation">,</span> neteqFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/pc/peer_connection_factory.cc</span>
<span class="token keyword">static</span> ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span>
<span class="token function">JNI_PeerConnectionFactory_CreatePeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jcontext<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> joptions<span class="token punctuation">,</span>
    jlong native_audio_device_module<span class="token punctuation">,</span>
    jlong native_audio_encoder_factory<span class="token punctuation">,</span>
    jlong native_audio_decoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jencoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jdecoder_factory<span class="token punctuation">,</span>
    jlong native_audio_processor<span class="token punctuation">,</span>
    jlong native_fec_controller_factory<span class="token punctuation">,</span>
    jlong native_network_controller_factory<span class="token punctuation">,</span>
    jlong native_network_state_predictor_factory<span class="token punctuation">,</span>
    jlong native_media_transport_factory<span class="token punctuation">,</span>
    jlong native_neteq_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioProcessing<span class="token operator">&gt;</span> audio_processor <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AudioProcessing<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">CreatePeerConnectionFactoryForJava</span><span class="token punctuation">(</span>
      jni<span class="token punctuation">,</span> jcontext<span class="token punctuation">,</span> joptions<span class="token punctuation">,</span>
      <span class="token comment">// Native &#x97F3;&#x9891;&#x8BBE;&#x5907;&#x5BF9;&#x8C61;</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_device_module<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfRefPtr<span class="token operator">&lt;</span>AudioEncoderFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_encoder_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfRefPtr<span class="token operator">&lt;</span>AudioDecoderFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_audio_decoder_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jencoder_factory<span class="token punctuation">,</span> jdecoder_factory<span class="token punctuation">,</span>
      <span class="token comment">// &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x589E;&#x5F3A;&#x5904;&#x7406;&#x5BF9;&#x8C61;</span>
      audio_processor <span class="token operator">?</span> audio_processor <span class="token operator">:</span> <span class="token function">CreateAudioProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>FecControllerFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_fec_controller_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetworkControllerFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_network_controller_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetworkStatePredictorFactoryInterface<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_network_state_predictor_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>MediaTransportFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          native_media_transport_factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
      TakeOwnershipOfUniquePtr<span class="token operator">&lt;</span>NetEqFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>native_neteq_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Following parameters are optional:</span>
<span class="token comment">// |audio_device_module|, |jencoder_factory|, |jdecoder_factory|,</span>
<span class="token comment">// |audio_processor|, |media_transport_factory|, |fec_controller_factory|,</span>
<span class="token comment">// |network_state_predictor_factory|, |neteq_factory|.</span>
ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">CreatePeerConnectionFactoryForJava</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jcontext<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> joptions<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">&gt;</span> audio_device_module<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioEncoderFactory<span class="token operator">&gt;</span> audio_encoder_factory<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDecoderFactory<span class="token operator">&gt;</span> audio_decoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jencoder_factory<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> jdecoder_factory<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioProcessing<span class="token operator">&gt;</span> audio_processor<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>FecControllerFactoryInterface<span class="token operator">&gt;</span> fec_controller_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetworkControllerFactoryInterface<span class="token operator">&gt;</span>
        network_controller_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetworkStatePredictorFactoryInterface<span class="token operator">&gt;</span>
        network_state_predictor_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>MediaTransportFactory<span class="token operator">&gt;</span> media_transport_factory<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NetEqFactory<span class="token operator">&gt;</span> neteq_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// talk/ assumes pretty widely that the current Thread is ThreadManager&apos;d, but</span>
    <span class="token comment">// ThreadManager only WrapCurrentThread()s the thread where it is first</span>
    <span class="token comment">// created.  Since the semantics around when auto-wrapping happens in</span>
    <span class="token comment">// webrtc/rtc_base/ are convoluted, we simply wrap here to avoid having to</span>
    <span class="token comment">// think about ramifications of auto-wrapping there.</span>
    rtc<span class="token operator">::</span><span class="token class-name">ThreadManager</span><span class="token operator">::</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">WrapCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; network &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> network_thread <span class="token operator">=</span>
        rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">CreateWithSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    network_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;network_thread&quot;</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>network_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; worker &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> worker_thread <span class="token operator">=</span> rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;worker_thread&quot;</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>worker_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; signaling &#x7EBF;&#x7A0B;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> signaling_thread <span class="token operator">=</span> rtc<span class="token operator">::</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signaling_thread<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span><span class="token string">&quot;signaling_thread&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>signaling_thread<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to start thread&quot;</span><span class="token punctuation">;</span>

    rtc<span class="token operator">::</span>NetworkMonitorFactory<span class="token operator">*</span> network_monitor_factory <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> absl<span class="token operator">::</span>optional<span class="token operator">&lt;</span>PeerConnectionFactoryInterface<span class="token operator">::</span>Options<span class="token operator">&gt;</span> options <span class="token operator">=</span>
        <span class="token function">JavaToNativePeerConnectionFactoryOptions</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> joptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Do not create network_monitor_factory only if the options are</span>
    <span class="token comment">// provided and disable_network_monitor therein is set to true.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token operator">-&gt;</span>disable_network_monitor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        network_monitor_factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">AndroidNetworkMonitorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rtc<span class="token operator">::</span><span class="token class-name">NetworkMonitorFactory</span><span class="token operator">::</span><span class="token function">SetFactory</span><span class="token punctuation">(</span>network_monitor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    PeerConnectionFactoryDependencies dependencies<span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_thread <span class="token operator">=</span> network_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>worker_thread <span class="token operator">=</span> worker_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>signaling_thread <span class="token operator">=</span> signaling_thread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>task_queue_factory <span class="token operator">=</span> <span class="token function">CreateDefaultTaskQueueFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>call_factory <span class="token operator">=</span> <span class="token function">CreateCallFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>event_log_factory <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>RtcEventLogFactory<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        dependencies<span class="token punctuation">.</span>task_queue_factory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>fec_controller_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fec_controller_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_controller_factory <span class="token operator">=</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_controller_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>network_state_predictor_factory <span class="token operator">=</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_state_predictor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>media_transport_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>media_transport_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies<span class="token punctuation">.</span>neteq_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>neteq_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cricket<span class="token operator">::</span>MediaEngineDependencies media_dependencies<span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>task_queue_factory <span class="token operator">=</span> dependencies<span class="token punctuation">.</span>task_queue_factory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x5916;&#x90E8;&#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;</span>
    media_dependencies<span class="token punctuation">.</span>adm <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_device_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_encoder_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_encoder_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_decoder_factory <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_decoder_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>audio_processing <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>video_encoder_factory <span class="token operator">=</span>
        absl<span class="token operator">::</span><span class="token function">WrapUnique</span><span class="token punctuation">(</span><span class="token function">CreateVideoEncoderFactory</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> jencoder_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    media_dependencies<span class="token punctuation">.</span>video_decoder_factory <span class="token operator">=</span>
        absl<span class="token operator">::</span><span class="token function">WrapUnique</span><span class="token punctuation">(</span><span class="token function">CreateVideoDecoderFactory</span><span class="token punctuation">(</span>jni<span class="token punctuation">,</span> jdecoder_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA; MediaEngine</span>
    dependencies<span class="token punctuation">.</span>media_engine <span class="token operator">=</span>
        cricket<span class="token operator">::</span><span class="token function">CreateMediaEngine</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>media_dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; PeerConnectionFactory&#xFF0C;&#x6B64;&#x8C03;&#x7528;&#x4E0E;&#x5176;&#x4ED6;&#x5E73;&#x53F0;&#x76F8;&#x540C;</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>PeerConnectionFactoryInterface<span class="token operator">&gt;</span> factory <span class="token operator">=</span>
        <span class="token function">CreateModularPeerConnectionFactory</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to create the peer connection factory; &quot;</span>
                            <span class="token string">&quot;WebRTC/libjingle init likely failed on this device&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO(honghaiz): Maybe put the options as the argument of</span>
    <span class="token comment">// CreatePeerConnectionFactory.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        factory<span class="token operator">-&gt;</span><span class="token function">SetOptions</span><span class="token punctuation">(</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">NativeToScopedJavaPeerConnectionFactory</span><span class="token punctuation">(</span>
        jni<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> network_monitor_factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">NativeToScopedJavaPeerConnectionFactory</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>webrtc<span class="token operator">::</span>PeerConnectionFactoryInterface<span class="token operator">&gt;</span> pcf<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> network_thread<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> worker_thread<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>rtc<span class="token operator">::</span>Thread<span class="token operator">&gt;</span> signaling_thread<span class="token punctuation">,</span>
    rtc<span class="token operator">::</span>NetworkMonitorFactory<span class="token operator">*</span> network_monitor_factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// OwnedFactoryAndThreads &#x4FDD;&#x5B58;&#x7EF4;&#x62A4; Native Factory &#x5BF9;&#x8C61;</span>
    OwnedFactoryAndThreads<span class="token operator">*</span> owned_factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">OwnedFactoryAndThreads</span><span class="token punctuation">(</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>network_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>signaling_thread<span class="token punctuation">)</span><span class="token punctuation">,</span> network_monitor_factory<span class="token punctuation">,</span> pcf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x521B;&#x5EFA; Java &#x5C42;&#x7684; PeerConnectionFactory &#x5B9E;&#x4F8B;</span>
    ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> j_pcf <span class="token operator">=</span> <span class="token function">Java_PeerConnectionFactory_Constructor</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> <span class="token function">NativeToJavaPointer</span><span class="token punctuation">(</span>owned_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onNetworkThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">network_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onNetworkThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onWorkerThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onWorkerThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x56DE;&#x8C03; PeerConnectionFactory.onSignalingThreadReady()</span>
    <span class="token function">PostJavaCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> owned_factory<span class="token operator">-&gt;</span><span class="token function">signaling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTC_FROM_HERE<span class="token punctuation">,</span> j_pcf<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>Java_PeerConnectionFactory_onSignalingThreadReady<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> j_pcf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span> <span class="token function">Java_PeerConnectionFactory_Constructor</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span>
    env<span class="token punctuation">,</span> jlong nativeFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_PeerConnectionFactory_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_PeerConnectionFactory_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_PeerConnectionFactory_Constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x6784;&#x9020; Java &#x5C42; PeerConnectionFactory &#x5B9E;&#x4F8B;</span>
    jobject ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">NewObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> base<span class="token operator">::</span>android<span class="token operator">::</span>ScopedJavaLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="12-%E5%88%9B%E5%BB%BA-peerconnection">1.2 &#x521B;&#x5EFA; PeerConnection</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token comment">/* &#x4FE1;&#x4EE4;&#x5C42;&#x8FDE;&#x63A5;&#x623F;&#x95F4;&#x670D;&#x52A1;&#x5668;&#x6210;&#x529F;, &#x521B;&#x5EFA; PeerConnection, &#x82E5;&#x662F;&#x4E3B;&#x53EB;&#x7AEF;&#x5219;&#x521B;&#x5EFA; offer sdp&#xFF0C;&#x82E5;&#x662F;&#x88AB;&#x53EB;&#x7AEF;&#x5219;&#x9700;&#x8BBE;&#x7F6E;&#x8FDC;&#x7AEF; Sdp &#x53CA;&#x521B;&#x5EFA;&#x672C;&#x7AEF; Sdp */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onConnectedToRoomInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SignalingParameters</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> delta <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> callStartedTimeMs<span class="token punctuation">;</span>

    signalingParameters <span class="token operator">=</span> params<span class="token punctuation">;</span>
    <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating peer connection, delay=&quot;</span> <span class="token operator">+</span> delta <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x5B9E;&#x4F8B;&#xFF0C;&#x53EF;&#x4E3A;&#xFF1A;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x3001;&#x5C4F;&#x5E55;&#x5171;&#x4EAB;&#x3001;&#x6444;&#x50CF;&#x5934;&#x91C7;&#x96C6; */</span>
    <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConnectionParameters<span class="token punctuation">.</span>videoCallEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createVideoCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* &#x521B;&#x5EFA; PeerConnection */</span>
    peerConnectionClient<span class="token punctuation">.</span><span class="token function">createPeerConnection</span><span class="token punctuation">(</span>
        localProxyVideoSink<span class="token punctuation">,</span> remoteSinks<span class="token punctuation">,</span> videoCapturer<span class="token punctuation">,</span> signalingParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>signalingParameters<span class="token punctuation">.</span>initiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating OFFER...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Create offer. Offer SDP will be sent to answering client in</span>
        <span class="token comment">// PeerConnectionEvents.onLocalDescription event.</span>
        peerConnectionClient<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>offerSdp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            peerConnectionClient<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>offerSdp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">logAndToast</span><span class="token punctuation">(</span><span class="token string">&quot;Creating ANSWER...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Create answer. Answer SDP will be sent to offering client in</span>
            <span class="token comment">// PeerConnectionEvents.onLocalDescription event.</span>
            peerConnectionClient<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>iceCandidates <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Add remote ICE candidates from room.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IceCandidate</span> iceCandidate <span class="token operator">:</span> params<span class="token punctuation">.</span>iceCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                peerConnectionClient<span class="token punctuation">.</span><span class="token function">addRemoteIceCandidate</span><span class="token punctuation">(</span>iceCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="2-%E9%9F%B3%E9%A2%91%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9D%97audiodevicemodule">2 &#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757;(AudioDeviceModule)</h2>

<p>&#x5916;&#x90E8;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x4EC5;&#x652F;&#x6301; java &#x5C42;&#x7EA7;&#xFF0C;&#x4E0D;&#x652F;&#x6301; OpenSLES. &#x501F;&#x7531; JavaAudioDeviceModule &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x548C;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5B9E;&#x4F8B;&#xFF0C;&#x5E76;&#x901A;&#x8FC7; Jni &#x521B;&#x5EFA; native C++ &#x5C42; AudioDeviceModule &#x5BF9;&#x8C61;&#x3002;</p>
<h3 class="mume-header" id="21-%E5%88%9B%E5%BB%BA-javaaudiodevicemodule">2.1 &#x521B;&#x5EFA; JavaAudioDeviceModule</h3>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// PeerConnectionClient.java</span>
<span class="token class-name">AudioDeviceModule</span> <span class="token function">createJavaAudioDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x91C7;&#x6837;&#x9891;&#x7387;&#x5728; Builder &#x6784;&#x9020;&#x65F6;&#x4ECE; WebRtcAudioManager &#x83B7;&#x53D6;&#x8BBE;&#x7F6E; */</span>
    <span class="token keyword">return</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span>
        <span class="token comment">/* &#x97F3;&#x9891;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x56DE;&#x8C03;&#xFF0C;&#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x5230;&#x6587;&#x4EF6; */</span>
        <span class="token punctuation">.</span><span class="token function">setSamplesReadyCallback</span><span class="token punctuation">(</span>saveRecordedAudioToFile<span class="token punctuation">)</span>
        <span class="token comment">/* &#x662F;&#x5426;&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x56DE;&#x58F0;&#x6D88;&#x9664;&#xFF0C;&#x9700;&#x8BBE;&#x5907;&#x652F;&#x6301; */</span>
        <span class="token punctuation">.</span><span class="token function">setUseHardwareAcousticEchoCanceler</span><span class="token punctuation">(</span><span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>disableBuiltInAEC<span class="token punctuation">)</span>
        <span class="token comment">/* &#x662F;&#x5426;&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x566A;&#x58F0;&#x6291;&#x5236;&#xFF0C;&#x9700;&#x8BBE;&#x5907;&#x652F;&#x6301; */</span>
        <span class="token punctuation">.</span><span class="token function">setUseHardwareNoiseSuppressor</span><span class="token punctuation">(</span><span class="token operator">!</span>peerConnectionParameters<span class="token punctuation">.</span>disableBuiltInNS<span class="token punctuation">)</span>
        <span class="token comment">/* &#x8BBE;&#x7F6E;&#x9519;&#x8BEF;&#x56DE;&#x8C03;&#x53CA;&#x72B6;&#x6001;&#x56DE;&#x8C03; */</span>
        <span class="token punctuation">.</span><span class="token function">setAudioRecordErrorCallback</span><span class="token punctuation">(</span>audioRecordErrorCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioTrackErrorCallback</span><span class="token punctuation">(</span>audioTrackErrorCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioRecordStateCallback</span><span class="token punctuation">(</span>audioRecordStateCallback<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAudioTrackStateCallback</span><span class="token punctuation">(</span>audioTrackStateCallback<span class="token punctuation">)</span>
        <span class="token comment">/* &#x6784;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
        <span class="token punctuation">.</span><span class="token function">createAudioDeviceModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/api/org/webrtc/JavaAudioDeviceModule.java</span>
<span class="token comment">// JavaAudioDeviceModule.Builder</span>
<span class="token keyword">public</span> <span class="token class-name">AudioDeviceModule</span> <span class="token function">createAudioDeviceModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x5B9E;&#x4F8B; sdk/android/src/java/org/webrtc/audio/WebRtcAudioRecord.java */</span>
    <span class="token keyword">final</span> <span class="token class-name">WebRtcAudioRecord</span> audioInput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebRtcAudioRecord</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioSource<span class="token punctuation">,</span>
        audioFormat<span class="token punctuation">,</span> audioRecordErrorCallback<span class="token punctuation">,</span> audioRecordStateCallback<span class="token punctuation">,</span> samplesReadyCallback<span class="token punctuation">,</span>
        useHardwareAcousticEchoCanceler<span class="token punctuation">,</span> useHardwareNoiseSuppressor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5B9E;&#x4F8B; sdk/android/src/java/org/webrtc/audio/WebRtcAudioTrack.java */</span>
    <span class="token keyword">final</span> <span class="token class-name">WebRtcAudioTrack</span> audioOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebRtcAudioTrack</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioTrackErrorCallback<span class="token punctuation">,</span> audioTrackStateCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907;&#x6A21;&#x5757; */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioInput<span class="token punctuation">,</span> audioOutput<span class="token punctuation">,</span>
        inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span> useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// JavaAudioDeviceModule &#x662F; AudioDeviceModule &#x63A5;&#x53E3;&#x7684;&#x6D3E;&#x751F;&#x7C7B;</span>
<span class="token keyword">private</span> <span class="token class-name">JavaAudioDeviceModule</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">AudioManager</span> audioManager<span class="token punctuation">,</span>
      <span class="token class-name">WebRtcAudioRecord</span> audioInput<span class="token punctuation">,</span> <span class="token class-name">WebRtcAudioTrack</span> audioOutput<span class="token punctuation">,</span> <span class="token keyword">int</span> inputSampleRate<span class="token punctuation">,</span>
      <span class="token keyword">int</span> outputSampleRate<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useStereoInput<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useStereoOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioManager <span class="token operator">=</span> audioManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioInput <span class="token operator">=</span> audioInput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioOutput <span class="token operator">=</span> audioOutput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inputSampleRate <span class="token operator">=</span> inputSampleRate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outputSampleRate <span class="token operator">=</span> outputSampleRate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>useStereoInput <span class="token operator">=</span> useStereoInput<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>useStereoOutput <span class="token operator">=</span> useStereoOutput<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x8BBE;&#x5907; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x521B;&#x5EFA; PeerConnectionFactory &#x65F6;&#x8C03;&#x7528; */</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getNativeAudioDeviceModulePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>nativeLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeAudioDeviceModule <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nativeAudioDeviceModule <span class="token operator">=</span> <span class="token function">nativeCreateAudioDeviceModule</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> audioManager<span class="token punctuation">,</span> audioInput<span class="token punctuation">,</span>
                audioOutput<span class="token punctuation">,</span> inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span> useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> nativeAudioDeviceModule<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="22-%E5%88%9B%E5%BB%BA-native-%E5%B1%82-audiodevicemodule">2.2 &#x521B;&#x5EFA; Native &#x5C42; AudioDeviceModule</h3>

<p>&#x901A;&#x8FC7;JNI &#x8C03;&#x7528;&#x521B;&#x5EFA; AudioDeviceModule</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_jni/JavaAudioDeviceModule_jni.h</span>
<span class="token comment">// &#x6B64;&#x6587;&#x4EF6;&#x4E3A;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;&#x4E2D;&#x52A8;&#x6001;&#x751F;&#x6210;</span>
JNI_GENERATOR_EXPORT jlong
    <span class="token function">Java_org_webrtc_audio_JavaAudioDeviceModule_nativeCreateAudioDeviceModule</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jclass jcaller<span class="token punctuation">,</span>
    jobject context<span class="token punctuation">,</span>
    jobject audioManager<span class="token punctuation">,</span>
    jobject audioInput<span class="token punctuation">,</span>
    jobject audioOutput<span class="token punctuation">,</span>
    jint inputSampleRate<span class="token punctuation">,</span>
    jint outputSampleRate<span class="token punctuation">,</span>
    jboolean useStereoInput<span class="token punctuation">,</span>
    jboolean useStereoOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">JNI_JavaAudioDeviceModule_CreateAudioDeviceModule</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
        <span class="token comment">/* Java &#x5C42; Context &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* Java &#x5C42; AudioManager &#x5F15;&#x7528;*/</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioManager<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token comment">/* Java &#x5C42; WebRtcAudioRecord &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioInput<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* Java &#x5C42; WebRtcAudioTrack &#x5F15;&#x7528; */</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audioOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        inputSampleRate<span class="token punctuation">,</span> outputSampleRate<span class="token punctuation">,</span>
        useStereoInput<span class="token punctuation">,</span> useStereoOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/audio_device/java_audio_device_module.cc</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_JavaAudioDeviceModule_CreateAudioDeviceModule</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_manager<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_record<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_track<span class="token punctuation">,</span>
    <span class="token keyword">int</span> input_sample_rate<span class="token punctuation">,</span>
    <span class="token keyword">int</span> output_sample_rate<span class="token punctuation">,</span>
    jboolean j_use_stereo_input<span class="token punctuation">,</span>
    jboolean j_use_stereo_output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AudioParameters input_parameters<span class="token punctuation">;</span>
    AudioParameters output_parameters<span class="token punctuation">;</span>
    <span class="token comment">/* &#x901A;&#x8FC7; AudioManager &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x53CA;&#x64AD;&#x653E;&#x7684;&#x76F8;&#x5173;&#x53C2;&#x6570; */</span>
    <span class="token function">GetAudioParameters</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> input_sample_rate<span class="token punctuation">,</span>
                        output_sample_rate<span class="token punctuation">,</span> j_use_stereo_input<span class="token punctuation">,</span>
                        j_use_stereo_output<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_parameters<span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>output_parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x91C7;&#x96C6; AudioRecordJni &#x5BF9;&#x8C61; */</span>
    <span class="token keyword">auto</span> audio_input <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>AudioRecordJni<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> input_parameters<span class="token punctuation">,</span> kHighLatencyModeDelayEstimateInMilliseconds<span class="token punctuation">,</span>
        j_webrtc_audio_record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x521B;&#x5EFA;&#x97F3;&#x9891;&#x64AD;&#x653E; AudioTrackJni &#x5BF9;&#x8C61; */</span>
    <span class="token keyword">auto</span> audio_output <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>AudioTrackJni<span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> output_parameters<span class="token punctuation">,</span>
                                                        j_webrtc_audio_track<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token function">CreateAudioDeviceModuleFromInputAndOutput</span><span class="token punctuation">(</span>
                                <span class="token comment">// AudioDeviceModule::AudioLayer</span>
                                AudioDeviceModule<span class="token operator">::</span>kAndroidJavaAudio<span class="token punctuation">,</span>
                                <span class="token comment">// &#x662F;&#x5426;&#x53CC;&#x58F0;&#x9053;</span>
                                j_use_stereo_input<span class="token punctuation">,</span> j_use_stereo_output<span class="token punctuation">,</span>
                                <span class="token comment">// &#x64AD;&#x653E;&#x5EF6;&#x65F6;&#x4F30;&#x8BA1;&#xFF0C;150ms</span>
                                kHighLatencyModeDelayEstimateInMilliseconds<span class="token punctuation">,</span>
                                <span class="token comment">// &#x97F3;&#x9891;&#x91C7;&#x96C6;&#x53CA;&#x64AD;&#x653E;&#x5BF9;&#x8C61;</span>
                                std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sdk/android/src/jni/audio_device/audio_device_module.cc</span>
<span class="token comment">// &#x521B;&#x5EFA; AudioDeviceModule(modules/audio_device/include/audio_device.h)&#xFF0C;</span>
<span class="token comment">// AndroidAudioDeviceModule &#x7EE7;&#x627F;&#x4E8E;&#x8BE5;&#x7C7B;.</span>
rtc<span class="token operator">::</span>scoped_refptr<span class="token operator">&lt;</span>AudioDeviceModule<span class="token operator">&gt;</span> <span class="token function">CreateAudioDeviceModuleFromInputAndOutput</span><span class="token punctuation">(</span>
    AudioDeviceModule<span class="token operator">::</span>AudioLayer audio_layer<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> is_stereo_playout_supported<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> is_stereo_record_supported<span class="token punctuation">,</span>
    <span class="token keyword">uint16_t</span> playout_delay_ms<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioInput<span class="token operator">&gt;</span> audio_input<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioOutput<span class="token operator">&gt;</span> audio_output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> __FUNCTION__<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> rtc<span class="token operator">::</span>RefCountedObject<span class="token operator">&lt;</span>AndroidAudioDeviceModule<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      audio_layer<span class="token punctuation">,</span> is_stereo_playout_supported<span class="token punctuation">,</span> is_stereo_record_supported<span class="token punctuation">,</span>
      playout_delay_ms<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">AndroidAudioDeviceModule</span><span class="token punctuation">(</span>AudioDeviceModule<span class="token operator">::</span>AudioLayer audio_layer<span class="token punctuation">,</span>
                           <span class="token keyword">bool</span> is_stereo_playout_supported<span class="token punctuation">,</span>
                           <span class="token keyword">bool</span> is_stereo_record_supported<span class="token punctuation">,</span>
                           <span class="token keyword">uint16_t</span> playout_delay_ms<span class="token punctuation">,</span>
                           std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioInput<span class="token operator">&gt;</span> audio_input<span class="token punctuation">,</span>
                           std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>AudioOutput<span class="token operator">&gt;</span> audio_output<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">audio_layer_</span><span class="token punctuation">(</span>audio_layer<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">is_stereo_playout_supported_</span><span class="token punctuation">(</span>is_stereo_playout_supported<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">is_stereo_record_supported_</span><span class="token punctuation">(</span>is_stereo_record_supported<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">playout_delay_ms_</span><span class="token punctuation">(</span>playout_delay_ms<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">task_queue_factory_</span><span class="token punctuation">(</span><span class="token function">CreateDefaultTaskQueueFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">input_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">output_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>audio_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>input_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>output_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> __FUNCTION__<span class="token punctuation">;</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="23-native-%E8%8E%B7%E5%8F%96%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86%E6%92%AD%E6%94%BE%E5%8F%82%E6%95%B0">2.3 Native &#x83B7;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x64AD;&#x653E;&#x53C2;&#x6570;</h3>

<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token comment">// sdk/android/src/jni/audio_device/audio_device_module.cc</span>
<span class="token keyword">void</span> <span class="token function">GetAudioParameters</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_context<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_manager<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> input_sample_rate<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> output_sample_rate<span class="token punctuation">,</span>
                        <span class="token keyword">bool</span> use_stereo_input<span class="token punctuation">,</span>
                        <span class="token keyword">bool</span> use_stereo_output<span class="token punctuation">,</span>
                        AudioParameters<span class="token operator">*</span> input_parameters<span class="token punctuation">,</span>
                        AudioParameters<span class="token operator">*</span> output_parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> output_channels <span class="token operator">=</span> use_stereo_output <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> input_channels <span class="token operator">=</span> use_stereo_input <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t output_buffer_size <span class="token operator">=</span> <span class="token function">Java_WebRtcAudioManager_getOutputBufferSize</span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> output_sample_rate<span class="token punctuation">,</span> output_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t input_buffer_size <span class="token operator">=</span> <span class="token function">Java_WebRtcAudioManager_getInputBufferSize</span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> j_context<span class="token punctuation">,</span> j_audio_manager<span class="token punctuation">,</span> input_sample_rate<span class="token punctuation">,</span> input_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
  output_parameters<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span>output_sample_rate<span class="token punctuation">,</span>
                           <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>output_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>output_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  input_parameters<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span>input_sample_rate<span class="token punctuation">,</span>
                          <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>input_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>input_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>input_parameters<span class="token operator">-&gt;</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RTC_CHECK</span><span class="token punctuation">(</span>output_parameters<span class="token operator">-&gt;</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_audio_device_module_base_jni/WebRTCAudioManager_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token comment">// &#x83B7;&#x53D6; AudioTrack &#x7684; getMinBufferSize</span>
<span class="token keyword">static</span> jint <span class="token function">Java_WebRtcAudioManager_getOutputBufferSize</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> audioManager<span class="token punctuation">,</span>
    JniIntWrapper sampleRate<span class="token punctuation">,</span>
    JniIntWrapper numberOfOutputChannels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_STATIC<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;getOutputBufferSize&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(Landroid/content/Context;Landroid/media/AudioManager;II)I&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioManager_getOutputBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7684; getOutputBufferSize() &#x65B9;&#x6CD5; */</span>
    jint ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">CallStaticIntMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> audioManager<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">as_jint</span><span class="token punctuation">(</span>sampleRate<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">as_jint</span><span class="token punctuation">(</span>numberOfOutputChannels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x83B7;&#x53D6; AudioRecord &#x7684; getMinBufferSize</span>
<span class="token keyword">static</span> jint <span class="token function">Java_WebRtcAudioManager_getInputBufferSize</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> audioManager<span class="token punctuation">,</span>
    JniIntWrapper sampleRate<span class="token punctuation">,</span>
    JniIntWrapper numberOfInputChannels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
        <span class="token function">org_webrtc_audio_WebRtcAudioManager_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
    call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
        base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_STATIC<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            env<span class="token punctuation">,</span>
            clazz<span class="token punctuation">,</span>
            <span class="token string">&quot;getInputBufferSize&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;(Landroid/content/Context;Landroid/media/AudioManager;II)I&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioManager_getInputBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; sdk/android/src/java/org/webrt/audio/WebRtcAudioManager.java &#x7684; getInputBufferSize() &#x65B9;&#x6CD5; */</span>
    jint ret <span class="token operator">=</span>
        env<span class="token operator">-&gt;</span><span class="token function">CallStaticIntMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>
            call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> audioManager<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">as_jint</span><span class="token punctuation">(</span>sampleRate<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">as_jint</span><span class="token punctuation">(</span>numberOfInputChannels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="24-%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86-audiorecordjni">2.4 &#x97F3;&#x9891;&#x91C7;&#x96C6; AudioRecordJni</h3>

<p>Native &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x6784;&#x5EFA;&#x65F6;&#x7ED1;&#x5B9A; Java &#x5C42;&#x7684; WebRtcAudioRecord &#x5B9E;&#x4F8B;&#xFF0C;&#x4EE5;&#x5B9E;&#x73B0;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x542F;&#x52A8;&#x53CA;&#x8BFB;&#x53D6;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x7F16;&#x7801;&#x53D1;&#x9001;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token class-name">AudioRecordJni</span><span class="token operator">::</span><span class="token function">AudioRecordJni</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> AudioParameters<span class="token operator">&amp;</span> audio_parameters<span class="token punctuation">,</span>
                               <span class="token keyword">int</span> total_delay_ms<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_audio_record<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">j_audio_record_</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_record<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &#x4FDD;&#x5B58; Java &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6; WebRtcAudioRecord &#x5B9E;&#x4F8B;&#x5F15;&#x7528;</span>
      <span class="token function">audio_parameters_</span><span class="token punctuation">(</span>audio_parameters<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">total_delay_ms_</span><span class="token punctuation">(</span>total_delay_ms<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_address_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_capacity_in_bytes_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">frames_per_buffer_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">recording_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">audio_device_buffer_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ctor&quot;</span><span class="token punctuation">;</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>audio_parameters_<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; Java&#x5C42;WebRtcAudioRecord&#x7684;setNativeAudioRecord &#x65B9;&#x6CD5;&#x8BBE;&#x7F6E; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x542F;&#x52A8;&#x97F3;&#x9891;&#x91C7;&#x96C6;&#x548C;&#x5C06;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x56DE;&#x8C03;C++&#x65F6;&#x4F7F;&#x7528; */</span>
    <span class="token function">Java_WebRtcAudioRecord_setNativeAudioRecord</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_record_<span class="token punctuation">,</span>
                                                jni<span class="token operator">::</span><span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Detach from this thread since construction is allowed to happen on a</span>
    <span class="token comment">// different thread.</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread_checker_java_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_device_module_native_jni/WebRtcAudioRecord_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; org/webrtc/audio/WebRtcAudioRecord.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Java_WebRtcAudioRecord_setNativeAudioRecord</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> obj<span class="token punctuation">,</span> jlong nativeAudioRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioRecord_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">org_webrtc_audio_WebRtcAudioRecord_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
  call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          env<span class="token punctuation">,</span>
          clazz<span class="token punctuation">,</span>
          <span class="token string">&quot;setNativeAudioRecord&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioRecord_setNativeAudioRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

     env<span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeAudioRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Java &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/audio/WebRtcAudioRecord.java</span>
<span class="token annotation punctuation">@CalledByNative</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNativeAudioRecord</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAudioRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAudioRecord <span class="token operator">=</span> nativeAudioRecord<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="25-%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE-audiotrackjni">2.5 &#x97F3;&#x9891;&#x64AD;&#x653E; AudioTrackJni</h3>

<p>Native &#x5C42;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x6784;&#x5EFA;&#x65F6;&#x7ED1;&#x5B9A;&#x5230; Java &#x5C42;&#x7684; WebRtcAudioTrack &#x5B9E;&#x4F8B;&#xFF0C;&#x5B9E;&#x73B0;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x521D;&#x59CB;&#x5316;&#x53CA;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x3002;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp"><span class="token class-name">AudioTrackJni</span><span class="token operator">::</span><span class="token function">AudioTrackJni</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> AudioParameters<span class="token operator">&amp;</span> audio_parameters<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> j_webrtc_audio_track<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">j_audio_track_</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_webrtc_audio_track<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &#x4FDD;&#x5B58; Java &#x5C42;&#x97F3;&#x9891;&#x91C7;&#x96C6; WebRtcAudioTrack &#x5B9E;&#x4F8B;&#x5F15;&#x7528;</span>
      <span class="token function">audio_parameters_</span><span class="token punctuation">(</span>audio_parameters<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_address_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">direct_buffer_capacity_in_bytes_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">frames_per_buffer_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initialized_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">playing_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">audio_device_buffer_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RTC_LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ctor&quot;</span><span class="token punctuation">;</span>
    <span class="token function">RTC_DCHECK</span><span class="token punctuation">(</span>audio_parameters_<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* &#x8C03;&#x7528; Java&#x5C42; WebRtcAudioTrack &#x7684; setNativeAudioTrac &#x65B9;&#x6CD5;&#x8BBE;&#x7F6E; Native &#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x542F;&#x52A8;&#x97F3;&#x9891;&#x64AD;&#x653E;&#x548C;&#x4ECE;C++&#x5C42;&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x6570;&#x636E;&#x65F6;&#x4F7F;&#x7528; */</span>
    <span class="token function">Java_WebRtcAudioTrack_setNativeAudioTrack</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_audio_track_<span class="token punctuation">,</span>
                                                jni<span class="token operator">::</span><span class="token function">jlongFromPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Detach from this thread since construction is allowed to happen on a</span>
    <span class="token comment">// different thread.</span>
    thread_checker_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread_checker_java_<span class="token punctuation">.</span><span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// out/android_arm64_Debug/gen/sdk/android/generated_java_audio_device_module_native_jni/WebRtcAudioTrack_jni.h</span>
<span class="token comment">// &#x8BE5;&#x6587;&#x4EF6;&#x6839;&#x636E; org/webrtc/audio/WebRtcAudioTrack.java &#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Java_WebRtcAudioTrack_setNativeAudioTrack</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span>
    base<span class="token operator">::</span>android<span class="token operator">::</span>JavaRef<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> obj<span class="token punctuation">,</span> jlong nativeAudioTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jclass clazz <span class="token operator">=</span> <span class="token function">org_webrtc_audio_WebRtcAudioTrack_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_CLAZZ</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">org_webrtc_audio_WebRtcAudioTrack_clazz</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  jni_generator<span class="token operator">::</span>JniJavaCallContextChecked call_context<span class="token punctuation">;</span>
  call_context<span class="token punctuation">.</span>Init<span class="token operator">&lt;</span>
      base<span class="token operator">::</span>android<span class="token operator">::</span>MethodID<span class="token operator">::</span>TYPE_INSTANCE<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          env<span class="token punctuation">,</span>
          clazz<span class="token punctuation">,</span>
          <span class="token string">&quot;setNativeAudioTrack&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>g_org_webrtc_audio_WebRtcAudioTrack_setNativeAudioTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>

     env<span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          call_context<span class="token punctuation">.</span>base<span class="token punctuation">.</span>method_id<span class="token punctuation">,</span> nativeAudioTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Java &#x5C42;&#x8C03;&#x7528;</p>
<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// sdk/android/src/java/org/webrtc/audio/WebRtcAudioTrack.java</span>
<span class="token annotation punctuation">@CalledByNative</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNativeAudioTrack</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeAudioTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nativeAudioTrack <span class="token operator">=</span> nativeAudioTrack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="3-%E8%A7%86%E9%A2%91%E5%9B%BE%E5%83%8F%E9%87%87%E9%9B%86%E6%A8%A1%E5%9D%97videocapturer">3 &#x89C6;&#x9891;&#x56FE;&#x50CF;&#x91C7;&#x96C6;&#x6A21;&#x5757;(VideoCapturer)</h2>

<p>&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90;&#x5206;&#x4E3A;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#xFF0C;&#x5C4F;&#x5E55;&#x5171;&#x4EAB;&#x53CA;&#x6444;&#x50CF;&#x5934;&#xFF0C;&#x8FD9;&#x51E0;&#x7C7B;&#x7EDF;&#x4E00;&#x7EE7;&#x627F;&#x4E86; VideoCapturer &#x7C7B;&#x3002;</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="922px" preserveAspectRatio="none" style="width:1675px;height:922px;" version="1.1" viewBox="0 0 1675 922" width="1675px" zoomAndPan="magnify"><defs><filter height="300%" id="f192pr0kqth6h4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[6a70cc93280952e553d5079bb37818cf]
cluster CameraSession--><polygon fill="#FFFFFF" filter="url(#f192pr0kqth6h4)" points="901,582,1016,582,1023,604.4883,1658,604.4883,1658,770,901,770,901,582" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="901" x2="1023" y1="604.4883" y2="604.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="905" y="597.5352">CameraSession</text><!--MD5=[e5ab114b80e753b114854575653dd8f1]
class CameraSession.CreateSessionCallback--><rect codeline="70" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="73.9102" id="CameraSession.CreateSessionCallback" style="stroke:#A80036;stroke-width:1.5;" width="304" x="1338" y="648.5"/><ellipse cx="1421.25" cy="664.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1417.6777,660.7651 L1417.6777,658.6069 L1425.0571,658.6069 L1425.0571,660.7651 L1422.5918,660.7651 L1422.5918,668.8418 L1425.0571,668.8418 L1425.0571,671 L1417.6777,671 L1417.6777,668.8418 L1420.1431,668.8418 L1420.1431,660.7651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="129" x="1441.75" y="669.0352">CreateSessionCallback</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1339" x2="1641" y1="680.5" y2="680.5"/><ellipse cx="1349" cy="691.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="202" x="1358" y="695.1348">void onDone(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="1339" x2="1641" y1="701.4551" y2="701.4551"/><ellipse cx="1349" cy="712.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="278" x="1358" y="716.0898">void onFailure(FailureType failureType, String error)</text><!--MD5=[3636f3d29bbd8a3b807fc9bf24b084e1]
class CameraSession.Events--><rect codeline="76" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="136.7754" id="CameraSession.Events" style="stroke:#A80036;stroke-width:1.5;" width="386" x="917" y="617"/><ellipse cx="1087.25" cy="633" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1083.6777,629.2651 L1083.6777,627.1069 L1091.0571,627.1069 L1091.0571,629.2651 L1088.5918,629.2651 L1088.5918,637.3418 L1091.0571,637.3418 L1091.0571,639.5 L1083.6777,639.5 L1083.6777,637.3418 L1086.1431,637.3418 L1086.1431,629.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="37" x="1107.75" y="637.5352">Events</text><line style="stroke:#A80036;stroke-width:1.5;" x1="918" x2="1302" y1="649" y2="649"/><ellipse cx="928" cy="660" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="135" x="937" y="663.6348">void onCameraOpening()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="918" x2="1302" y1="669.9551" y2="669.9551"/><ellipse cx="928" cy="680.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="312" x="937" y="684.5898">void onCameraError(CameraSession session, String error)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="918" x2="1302" y1="690.9102" y2="690.9102"/><ellipse cx="928" cy="701.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="288" x="937" y="705.5449">void onCameraDisconnected(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="918" x2="1302" y1="711.8652" y2="711.8652"/><ellipse cx="928" cy="722.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="252" x="937" y="726.5">void onCameraClosed(CameraSession session)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="918" x2="1302" y1="732.8203" y2="732.8203"/><ellipse cx="928" cy="743.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="360" x="937" y="747.4551">void onFrameCaptured(CameraSession session, VideoFrame frame)</text><!--MD5=[4c84326b91249774fba9d49891354c9b]
class CapturerObserver--><rect codeline="2" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="94.8652" id="CapturerObserver" style="stroke:#A80036;stroke-width:1.5;" width="254" x="7" y="638"/><ellipse cx="77.75" cy="654" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M74.1777,650.2651 L74.1777,648.1069 L81.5571,648.1069 L81.5571,650.2651 L79.0918,650.2651 L79.0918,658.3418 L81.5571,658.3418 L81.5571,660.5 L74.1777,660.5 L74.1777,658.3418 L76.6431,658.3418 L76.6431,650.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="104" x="98.25" y="658.5352">CapturerObserver</text><line style="stroke:#A80036;stroke-width:1.5;" x1="8" x2="260" y1="670" y2="670"/><ellipse cx="18" cy="681" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="223" x="27" y="684.6348">void onCapturerStarted(boolean success)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="260" y1="690.9551" y2="690.9551"/><ellipse cx="18" cy="701.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="140" x="27" y="705.5898">void onCapturerStopped()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="260" y1="711.9102" y2="711.9102"/><ellipse cx="18" cy="722.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="228" x="27" y="726.5449">void onFrameCaptured(VideoFrame frame)</text><!--MD5=[d1851ec3eb8f60324b913a0e219678d1]
class VideoCapturer--><rect codeline="10" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="157.7305" id="VideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="383" x="957.5" y="7"/><ellipse cx="1102.75" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1099.1777,19.2651 L1099.1777,17.1069 L1106.5571,17.1069 L1106.5571,19.2651 L1104.0918,19.2651 L1104.0918,27.3418 L1106.5571,27.3418 L1106.5571,29.5 L1099.1777,29.5 L1099.1777,27.3418 L1101.6431,27.3418 L1101.6431,19.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="84" x="1123.25" y="27.5352">VideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="958.5" x2="1339.5" y1="39" y2="39"/><ellipse cx="968.5" cy="50" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="357" x="977.5" y="53.6348">void initialize(SurfaceTextureHelper , Context , CapturerObserver )</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="958.5" x2="1339.5" y1="59.9551" y2="59.9551"/><ellipse cx="968.5" cy="70.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="280" x="977.5" y="74.5898">void startCapture(int width, int height, int framerate)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="958.5" x2="1339.5" y1="80.9102" y2="80.9102"/><ellipse cx="968.5" cy="91.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="101" x="977.5" y="95.5449">void stopCapture()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="958.5" x2="1339.5" y1="101.8652" y2="101.8652"/><ellipse cx="968.5" cy="112.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="332" x="977.5" y="116.5">void changeCaptureFormat(int width, int height, int framerate)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="958.5" x2="1339.5" y1="122.8203" y2="122.8203"/><ellipse cx="968.5" cy="133.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="977.5" y="137.4551">void dispose()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="958.5" x2="1339.5" y1="143.7754" y2="143.7754"/><ellipse cx="968.5" cy="154.7754" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="121" x="977.5" y="158.4102">boolean isScreencast()</text><!--MD5=[e3b91f50f7e38913945d788d24b04423]
class CameraVideoCapturer--><rect codeline="24" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="73.9102" id="CameraVideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="362" x="668" y="225"/><ellipse cx="780.25" cy="241" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M776.6777,237.2651 L776.6777,235.1069 L784.0571,235.1069 L784.0571,237.2651 L781.5918,237.2651 L781.5918,245.3418 L784.0571,245.3418 L784.0571,247.5 L776.6777,247.5 L776.6777,245.3418 L779.1431,245.3418 L779.1431,237.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="129" x="800.75" y="245.5352">CameraVideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="669" x2="1029" y1="257" y2="257"/><ellipse cx="679" cy="268" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="229" x="688" y="271.6348">void switchCamera(CameraSwitchHandler )</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="669" x2="1029" y1="277.9551" y2="277.9551"/><ellipse cx="679" cy="288.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="336" x="688" y="292.5898">void switchCamera(CameraSwitchHandler, String cameraName)</text><!--MD5=[d06c03ccfbdce18b1281f2fd6fb25f4d]
class CameraCapturer--><rect codeline="30" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="195.6406" id="CameraCapturer" style="stroke:#A80036;stroke-width:1.5;" width="354" x="672" y="363"/><ellipse cx="796.75" cy="379" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M796.8633,374.5981 L795.7095,379.6699 L798.0254,379.6699 Z M795.3691,372.3569 L798.3657,372.3569 L801.7109,384.75 L799.2622,384.75 L798.4985,381.687 L795.2197,381.687 L794.4727,384.75 L792.0239,384.75 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="96" x="817.25" y="383.5352">CameraCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="673" x2="1025" y1="395" y2="395"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="680" y="419.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="209" x="692" y="426.5898">CameraEnumerator cameraEnumerator</text><line style="stroke:#A80036;stroke-width:1.0;" x1="673" x2="837.5" y1="409.4775" y2="409.4775"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="23" x="837.5" y="413.1348">field</text><line style="stroke:#A80036;stroke-width:1.0;" x1="860.5" x2="1025" y1="409.4775" y2="409.4775"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="673" x2="1025" y1="432.9102" y2="432.9102"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="680" y="440.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="328" x="692" y="447.5449">CameraSession.CreateSessionCallback createSessionCallback</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="673" x2="1025" y1="453.8652" y2="453.8652"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="680" y="461.8652"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="280" x="692" y="468.5">CameraSession.Events cameraSessionEventsHandler</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="673" x2="1025" y1="474.8203" y2="474.8203"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="680" y="482.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="197" x="692" y="489.4551">CapturerObserver capturerObserver</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="673" x2="1025" y1="495.7754" y2="495.7754"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="680" y="503.7754"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="166" x="692" y="510.4102">CameraSession currentSession</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="673" x2="1025" y1="516.7305" y2="516.7305"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="680" y="524.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="231" x="692" y="531.3652">CameraSwitchHandler switchEventsHandler</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="673" x2="1025" y1="537.6855" y2="537.6855"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="680" y="545.6855"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="179" x="692" y="552.3203">CameraStatistics cameraStatistics</text><!--MD5=[f29480f3f6be8cdc6b3952e942fd3cfa]
class CameraEnumerator--><rect codeline="88" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="136.7754" id="CameraEnumerator" style="stroke:#A80036;stroke-width:1.5;" width="585" x="296.5" y="617"/><ellipse cx="528.75" cy="633" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M525.1777,629.2651 L525.1777,627.1069 L532.5571,627.1069 L532.5571,629.2651 L530.0918,629.2651 L530.0918,637.3418 L532.5571,637.3418 L532.5571,639.5 L525.1777,639.5 L525.1777,637.3418 L527.6431,637.3418 L527.6431,629.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="112" x="549.25" y="637.5352">CameraEnumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="297.5" x2="880.5" y1="649" y2="649"/><ellipse cx="307.5" cy="660" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="139" x="316.5" y="663.6348">String[] getDeviceNames()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="669.9551" y2="669.9551"/><ellipse cx="307.5" cy="680.9551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="226" x="316.5" y="684.5898">boolean isFrontFacing(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="690.9102" y2="690.9102"/><ellipse cx="307.5" cy="701.9102" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="221" x="316.5" y="705.5449">boolean isBackFacing(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="711.8652" y2="711.8652"/><ellipse cx="307.5" cy="722.8652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="345" x="316.5" y="726.5">List&lt;CaptureFormat&gt; getSupportedFormats(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="297.5" x2="880.5" y1="732.8203" y2="732.8203"/><ellipse cx="307.5" cy="743.8203" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="559" x="316.5" y="747.4551">CameraVideoCapturer createCapturer(String deviceName, CameraVideoCapturer.CameraEventsHandler )</text><!--MD5=[aa426e197ea1e471f3259685cb0cadc0]
class ScreenCapturerAndroid--><rect codeline="52" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="48" id="ScreenCapturerAndroid" style="stroke:#A80036;stroke-width:1.5;" width="167" x="1065.5" y="238"/><ellipse cx="1080.5" cy="254" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1082.9731,260.1431 Q1082.3921,260.4419 1081.7529,260.5913 Q1081.1138,260.7407 1080.4082,260.7407 Q1077.9014,260.7407 1076.5815,259.0889 Q1075.2617,257.437 1075.2617,254.3159 Q1075.2617,251.1865 1076.5815,249.5347 Q1077.9014,247.8828 1080.4082,247.8828 Q1081.1138,247.8828 1081.7612,248.0322 Q1082.4087,248.1816 1082.9731,248.4805 L1082.9731,251.2031 Q1082.3423,250.6221 1081.7488,250.3523 Q1081.1553,250.0825 1080.5244,250.0825 Q1079.1797,250.0825 1078.4949,251.1492 Q1077.8101,252.2158 1077.8101,254.3159 Q1077.8101,256.4077 1078.4949,257.4744 Q1079.1797,258.541 1080.5244,258.541 Q1081.1553,258.541 1081.7488,258.2712 Q1082.3423,258.0015 1082.9731,257.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="135" x="1094.5" y="258.5352">ScreenCapturerAndroid</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1066.5" x2="1231.5" y1="270" y2="270"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1066.5" x2="1231.5" y1="278" y2="278"/><!--MD5=[1759e3376b35249d894d8171cd4e7b48]
class FileVideoCapturer--><rect codeline="56" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="48" id="FileVideoCapturer" style="stroke:#A80036;stroke-width:1.5;" width="135" x="1267.5" y="238"/><ellipse cx="1282.5" cy="254" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1284.9731,260.1431 Q1284.3921,260.4419 1283.7529,260.5913 Q1283.1138,260.7407 1282.4082,260.7407 Q1279.9014,260.7407 1278.5815,259.0889 Q1277.2617,257.437 1277.2617,254.3159 Q1277.2617,251.1865 1278.5815,249.5347 Q1279.9014,247.8828 1282.4082,247.8828 Q1283.1138,247.8828 1283.7612,248.0322 Q1284.4087,248.1816 1284.9731,248.4805 L1284.9731,251.2031 Q1284.3423,250.6221 1283.7488,250.3523 Q1283.1553,250.0825 1282.5244,250.0825 Q1281.1797,250.0825 1280.4949,251.1492 Q1279.8101,252.2158 1279.8101,254.3159 Q1279.8101,256.4077 1280.4949,257.4744 Q1281.1797,258.541 1282.5244,258.541 Q1283.1553,258.541 1283.7488,258.2712 Q1284.3423,258.0015 1284.9731,257.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="103" x="1296.5" y="258.5352">FileVideoCapturer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1268.5" x2="1401.5" y1="270" y2="270"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1268.5" x2="1401.5" y1="278" y2="278"/><!--MD5=[19d1df133ca1013884d79ec64d03160b]
class CameraSession--><rect codeline="66" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="48" id="CameraSession" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1375.5" y="62"/><ellipse cx="1390.5" cy="78" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1386.9277,74.2651 L1386.9277,72.1069 L1394.3071,72.1069 L1394.3071,74.2651 L1391.8418,74.2651 L1391.8418,82.3418 L1394.3071,82.3418 L1394.3071,84.5 L1386.9277,84.5 L1386.9277,82.3418 L1389.3931,82.3418 L1389.3931,74.2651 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="87" x="1404.5" y="82.5352">CameraSession</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1376.5" x2="1493.5" y1="94" y2="94"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1376.5" x2="1493.5" y1="102" y2="102"/><!--MD5=[d0ac0e6c7ffe0f9fe41145a86d5243f6]
class Camera1Enumerator--><rect codeline="100" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="94.8652" id="Camera1Enumerator" style="stroke:#A80036;stroke-width:1.5;" width="338" x="219" y="814"/><ellipse cx="323.75" cy="830" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M326.2231,836.1431 Q325.6421,836.4419 325.0029,836.5913 Q324.3638,836.7407 323.6582,836.7407 Q321.1514,836.7407 319.8315,835.0889 Q318.5117,833.437 318.5117,830.3159 Q318.5117,827.1865 319.8315,825.5347 Q321.1514,823.8828 323.6582,823.8828 Q324.3638,823.8828 325.0112,824.0322 Q325.6587,824.1816 326.2231,824.4805 L326.2231,827.2031 Q325.5923,826.6221 324.9988,826.3523 Q324.4053,826.0825 323.7744,826.0825 Q322.4297,826.0825 321.7449,827.1492 Q321.0601,828.2158 321.0601,830.3159 Q321.0601,832.4077 321.7449,833.4744 Q322.4297,834.541 323.7744,834.541 Q324.4053,834.541 324.9988,834.2712 Q325.5923,834.0015 326.2231,833.4204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="344.25" y="834.5352">Camera1Enumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="220" x2="556" y1="846" y2="846"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="854"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="199" x="239" y="860.6348">CameraInfo getCameraInfo(int index)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="220" x2="556" y1="866.9551" y2="866.9551"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="874.9551"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="312" x="239" y="881.5898">List&lt;CaptureFormat&gt; getSupportedFormats(int cameraId)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="220" x2="556" y1="887.9102" y2="887.9102"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="227" y="895.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="172" x="239" y="902.5449">String getDeviceName(int index)</text><!--MD5=[48b3b187716a986d22b2634aa7919951]
class Camera2Enumerator--><rect codeline="108" fill="#FEFECE" filter="url(#f192pr0kqth6h4)" height="73.9102" id="Camera2Enumerator" style="stroke:#A80036;stroke-width:1.5;" width="397" x="592.5" y="824.5"/><ellipse cx="726.75" cy="840.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M729.2231,846.6431 Q728.6421,846.9419 728.0029,847.0913 Q727.3638,847.2407 726.6582,847.2407 Q724.1514,847.2407 722.8315,845.5889 Q721.5117,843.937 721.5117,840.8159 Q721.5117,837.6865 722.8315,836.0347 Q724.1514,834.3828 726.6582,834.3828 Q727.3638,834.3828 728.0112,834.5322 Q728.6587,834.6816 729.2231,834.9805 L729.2231,837.7031 Q728.5923,837.1221 727.9988,836.8523 Q727.4053,836.5825 726.7744,836.5825 Q725.4297,836.5825 724.7449,837.6492 Q724.0601,838.7158 724.0601,840.8159 Q724.0601,842.9077 724.7449,843.9744 Q725.4297,845.041 726.7744,845.041 Q727.4053,845.041 727.9988,844.7712 Q728.5923,844.5015 729.2231,843.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="747.25" y="845.0352">Camera2Enumerator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="593.5" x2="988.5" y1="856.5" y2="856.5"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="600.5" y="864.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="371" x="612.5" y="871.1348">CameraCharacteristics getCameraCharacteristics(String deviceName)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="593.5" x2="988.5" y1="877.4551" y2="877.4551"/><ellipse cx="603.5" cy="888.4551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="206" x="612.5" y="892.0898">boolean isSupported(Context context)</text><!--MD5=[a76226dc26b1373157892c246612775a]
reverse link CameraCapturer to CapturerObserver--><path codeline="46" d="M657.86,481.03 C489.33,481.85 436.82,499.31 279,574 C244.67,590.25 210.66,615.54 184.22,637.83 " fill="none" id="CameraCapturer-backto-CapturerObserver" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="671,481,664.9912,477.0132,659,481.0264,665.0088,485.0132,671,481" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[8d16be48a47b929c2ce8b9a62009a270]
reverse link CameraCapturer to CameraEnumerator--><path codeline="47" d="M657.75,422.11 C587.98,434.23 580.16,543.34 583.03,616.98 " fill="none" id="CameraCapturer-backto-CameraEnumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="671,421,664.6908,417.5081,659.0408,421.9889,665.35,425.4808,671,421" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[a7eb497215feabb92724f152131991f3]
reverse link CameraCapturer to CameraSession.CreateSessionCallback--><path codeline="48" d="M1040.14,441.26 C1211.61,447.9 1379.64,582.17 1452.4,648.31 " fill="none" id="CameraCapturer-backto-CameraSession.CreateSessionCallback" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1027,441,1032.9197,445.1179,1038.9977,441.2373,1033.0779,437.1194,1027,441" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[a4c2fda8eb8258592542379c8c0e4447]
reverse link CameraCapturer to CameraSession.Events--><path codeline="49" d="M1040.08,462.23 C1096.29,473.2 1109.73,555.55 1111.79,616.84 " fill="none" id="CameraCapturer-backto-CameraSession.Events" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1027,461,1032.6001,465.543,1038.9475,462.1209,1033.3474,457.5779,1027,461" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[0e5c36ed9415cc814f2ee6f1a4d4d3de]
reverse link VideoCapturer to CameraVideoCapturer--><path codeline="60" d="M997.01,175.15 C966.65,192.76 936.4,210.31 911.24,224.9 " fill="none" id="VideoCapturer-backto-CameraVideoCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="993.54,169.07,1014.36,165.09,1000.57,181.18,993.54,169.07" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[f8c41590d8f2eb1f8ea3547becc6765a]
reverse link VideoCapturer to ScreenCapturerAndroid--><path codeline="61" d="M1149,185.24 C1149,204.87 1149,223.72 1149,237.71 " fill="none" id="VideoCapturer-backto-ScreenCapturerAndroid" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1142,185.09,1149,165.09,1156,185.09,1142,185.09" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[ba5a5a5aded9a8bf530f8f378f6be3f8]
reverse link VideoCapturer to FileVideoCapturer--><path codeline="62" d="M1247.4,179.05 C1270.72,200.87 1293.58,222.25 1310.1,237.71 " fill="none" id="VideoCapturer-backto-FileVideoCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="1242.3,183.87,1232.48,165.09,1251.87,173.64,1242.3,183.87" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[40285a18b05116a2bb5bc3c9c80bb875]
reverse link CameraVideoCapturer to CameraCapturer--><path codeline="64" d="M849,319.38 C849,331.81 849,345.33 849,358.89 " fill="none" id="CameraVideoCapturer-backto-CameraCapturer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="842,319.04,849,299.04,856,319.04,842,319.04" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[c6795812616f4a997f5cf1c0e50b3d3c]
reverse link CameraEnumerator to Camera1Enumerator--><path codeline="114" d="M495.68,767.28 C477.29,783.21 458.57,799.41 442.01,813.74 " fill="none" id="CameraEnumerator-backto-Camera1Enumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="491.3,761.82,511,754.02,500.46,772.4,491.3,761.82" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[455f21439928cf20c750eb6a7b86455e]
reverse link CameraEnumerator to Camera2Enumerator--><path codeline="115" d="M682.57,767.1 C705.88,787.18 729.72,807.71 749.08,824.39 " fill="none" id="CameraEnumerator-backto-Camera2Enumerator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="none" points="677.97,772.38,667.39,754.02,687.11,761.77,677.97,772.38" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[05d53f75e5ddc1f7ecc2141d8a147993]
@startuml

interface CapturerObserver {
    + void onCapturerStarted(boolean success)
    ..
    + void onCapturerStopped()
    ..
    + void onFrameCaptured(VideoFrame frame)
}

interface VideoCapturer {
    + void initialize(SurfaceTextureHelper , Context , CapturerObserver )
    ..
    + void startCapture(int width, int height, int framerate)
    ..
    + void stopCapture()
    ..
    + void changeCaptureFormat(int width, int height, int framerate)
    ..
    + void dispose()
    ..
    + boolean isScreencast()
}

interface CameraVideoCapturer {
    + void switchCamera(CameraSwitchHandler )
    ..
    + void switchCamera(CameraSwitchHandler, String cameraName)
}

abstract class CameraCapturer {
    - - field - -
    - {field} CameraEnumerator cameraEnumerator
    ..
    - {field} CameraSession.CreateSessionCallback createSessionCallback
    ..
    - {field} CameraSession.Events cameraSessionEventsHandler
    ..
    - {field} CapturerObserver capturerObserver
    ..
    - {field} CameraSession currentSession
    ..
    - {field} CameraSwitchHandler switchEventsHandler
    ..
    - {field} CameraStatistics cameraStatistics
}
CameraCapturer::capturerObserver *- - CapturerObserver
CameraCapturer::cameraEnumerator *- - CameraEnumerator
CameraCapturer::createSessionCallback *- - CameraSession.CreateSessionCallback
CameraCapturer::cameraSessionEventsHandler *- - CameraSession.Events


class ScreenCapturerAndroid {

}

class FileVideoCapturer {

}

VideoCapturer <|- - CameraVideoCapturer
VideoCapturer <|- - ScreenCapturerAndroid
VideoCapturer <|- - FileVideoCapturer

CameraVideoCapturer <|- - CameraCapturer

interface CameraSession {
    
}

interface CameraSession.CreateSessionCallback {
    + void onDone(CameraSession session)
    ..
    + void onFailure(FailureType failureType, String error)
}

interface CameraSession.Events {
    + void onCameraOpening()
    ..
    + void onCameraError(CameraSession session, String error)
    ..
    + void onCameraDisconnected(CameraSession session)
    ..
    + void onCameraClosed(CameraSession session)
    ..
    + void onFrameCaptured(CameraSession session, VideoFrame frame)
}

interface CameraEnumerator {
    + String[] getDeviceNames()
    ..
    + boolean isFrontFacing(String deviceName)
    ..
    + boolean isBackFacing(String deviceName)
    ..
    + List<CaptureFormat> getSupportedFormats(String deviceName)
    ..
    + CameraVideoCapturer createCapturer(String deviceName, CameraVideoCapturer.CameraEventsHandler )
}

class Camera1Enumerator {
    - {static} CameraInfo getCameraInfo(int index)
    ..
    - {static} List<CaptureFormat> getSupportedFormats(int cameraId)
    ..
    - {static} String getDeviceName(int index)
}

class Camera2Enumerator {
    - {method} CameraCharacteristics getCameraCharacteristics(String deviceName)
    ..
    + {static} boolean isSupported(Context context)
}

CameraEnumerator <|- - Camera1Enumerator
CameraEnumerator <|- - Camera2Enumerator
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg></p><pre data-role="codeBlock" data-info="java" class="language-java"><span class="token comment">// CallActivity.java</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">VideoCapturer</span> <span class="token function">createVideoCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">VideoCapturer</span> videoCapturer<span class="token punctuation">;</span>
    <span class="token class-name">String</span> videoFileAsCamera <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>EXTRA_VIDEO_FILE_AS_CAMERA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* &#x89C6;&#x9891;&#x6587;&#x4EF6;&#x4F5C;&#x4E3A;&#x89C6;&#x9891;&#x91C7;&#x96C6;&#x6E90; */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoFileAsCamera <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            videoCapturer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileVideoCapturer</span><span class="token punctuation">(</span>videoFileAsCamera<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open video file for emulated camera&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>screencaptureEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* &#x5C4F;&#x5E55;&#x5171;&#x4EAB; */</span>
        <span class="token keyword">return</span> <span class="token function">createScreenCapturer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useCamera2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Camera2 Api */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">captureToTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>camera2_texture_only_error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating capturer using camera2 API.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Camera Api */</span>
        <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating capturer using camera1 API.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        videoCapturer <span class="token operator">=</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span><span class="token function">captureToTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open camera&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">VideoCapturer</span> <span class="token function">createCameraCapturer</span><span class="token punctuation">(</span><span class="token class-name">CameraEnumerator</span> enumerator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x8BBE;&#x5907;&#x6444;&#x50CF;&#x5934;&#x4FE1;&#x606F; */</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> deviceNames <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">getDeviceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// First, try to find front facing camera</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Looking for front facing cameras.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x521B;&#x5EFA;&#x524D;&#x7F6E;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> deviceName <span class="token operator">:</span> deviceNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enumerator<span class="token punctuation">.</span><span class="token function">isFrontFacing</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating front facing camera capturer.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">createCapturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Front facing camera not found, try something else</span>
    <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Looking for other cameras.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &#x82E5;&#x65E0;&#x524D;&#x7F6E;&#x6444;&#x50CF;&#x5934;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x540E;&#x7F6E;&#x6444;&#x50CF;&#x5934;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> deviceName <span class="token operator">:</span> deviceNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enumerator<span class="token punctuation">.</span><span class="token function">isFrontFacing</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Logging</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Creating other camera capturer.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">VideoCapturer</span> videoCapturer <span class="token operator">=</span> enumerator<span class="token punctuation">.</span><span class="token function">createCapturer</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>videoCapturer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> videoCapturer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="31-%E5%88%9B%E5%BB%BAcamera1%E9%87%87%E9%9B%86">3.1 &#x521B;&#x5EFA;Camera1&#x91C7;&#x96C6;</h3>

<p>&#x6444;&#x50CF;&#x5934;&#x679A;&#x4E3E;&#x7C7B; Camera1Enumerator &#x548C; Camera2Enumerator &#x7EE7;&#x627F;&#x4E8E; CameraEnumerator&#x3002;</p>
<h4 class="mume-header" id="311-%E5%88%9B%E5%BB%BAcamera1%E6%9E%9A%E4%B8%BEcamera1enumerator">3.1.1 &#x521B;&#x5EFA;Camera1&#x679A;&#x4E3E;(Camera1Enumerator)</h4>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token keyword">public</span> <span class="token class-name">Camera1Enumerator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> captureToTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>captureToTexture <span class="token operator">=</span> captureToTexture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="312-%E5%88%9B%E5%BB%BA-cameracapturer">3.1.2 &#x521B;&#x5EFA; CameraCapturer</h4>

<pre data-role="codeBlock" data-info="java" class="language-java"></pre><h3 class="mume-header" id="32-%E5%88%9B%E5%BB%BAcamera2%E9%87%87%E9%9B%86">3.2 &#x521B;&#x5EFA;Camera2&#x91C7;&#x96C6;</h3>

<p>Camera2 &#x5FC5;&#x987B;&#x542F;&#x7528; Texture &#x624D;&#x80FD;&#x6E32;&#x67D3;&#x3002;</p>
<h4 class="mume-header" id="321-%E5%88%9B%E5%BB%BA-camera2-%E6%9E%9A%E4%B8%BEcamera2enumerator">3.2.1 &#x521B;&#x5EFA; Camera2 &#x679A;&#x4E3E;(Camera2Enumerator)</h4>

<pre data-role="codeBlock" data-info="java" class="language-java"><span class="token keyword">public</span> <span class="token class-name">Camera2Enumerator</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">/* &#x83B7;&#x53D6;&#x7CFB;&#x7EDF;&#x6444;&#x50CF;&#x5934;&#x7BA1;&#x7406;&#x670D;&#x52A1; */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cameraManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CameraManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>CAMERA_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre>
      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>